---
layout: post
title: 简单试用Skynet
categories: [general]
tags: [c]
---

公司立了个新项目，让我设计下服务器端，趁机尝试一下skynet。

## 为何要尝试skynet ##
我们团队熟悉的是剑三、剑世这类金山系游戏服务器的一个GameCenter多个GameServer的拓扑结构，其中存在一些问题：

1. GameServer的单线程模型性能瓶颈不好优化，例如领土战类的大量玩家聚集单张地图的PVP活动，不好再把一些功能拆分出去。
1. 服务器只有一个控制主循环的功能，给程序员的随意性太大，于是制定了很多固定的写法来写功能，新人的学习成本较高。
1. 跨进程模块逻辑状态复杂，容易出问题，如：登陆，跨服逻辑状态复杂，维护成本高。
 
skynet存在以下优点：

1. 利用多核优势，和异步交互方式，是解决我们现有性能瓶颈问题的一个思路。
1. skynet有至少两款产品在使用，而且有一款千万流水的产品，其稳定性和性能是有保证的。
1. 采用代码糖将一些异步操作封装为同步操作，可以降低新人的学习成本。[dinghim] 用几个小时开发了我们的创建角色及游戏登陆功能，流程上比原有的清晰简单多了。

使用skynet存在以下问题：

1. 遇到诡异问题时的解决成本比原有设计要高。
1. 项目间互相帮忙的问题，好在入门成本不高。

选择skynet的理由：

1. 新项目全部由新人组成。没有我们原有项目的开发经验，都是学习，学一个比较容易入门的比较好。（但是精通的成本要高。）
1. 我只是新项目的顾问，我的首要职责是现有项目的主程序，对于新项目，我不参与功能开发，只评审设计方案和培养新人。从这点而言，采用原有方案让新人写一个考虑周全的登陆、跨服逻辑又不太靠谱。

总而言之，使用skynet是突破我们固有思路的一个尝试，好处多于坏处。

## 目标 ##
我和[dinghim]抽一些非工作时间，将现有手游的服务端的部分功能使用skynet驱动起来，实现与客户端完成基本的交互。包括：创建角色，游戏角色登陆，完成简单的游戏功能（探索功能）。
[计划及进展](https://github.com/dpull/skynet_demo/issues)

## 简介 ##
Skynet是多线程的消息分发系统。
其脚本扩展利用了lua的协程，将一些异步操作抽象为了同步操作，使代码逻辑能更清晰一些，但从查bug的角度来看，这样做未必是好事。

举个例子：
加载玩家数据，我们现在的做法是，有两条协议，一条是请求加载，一条是加载成功的回调，需要实现两个函数，skynet使用协程将其隐藏， 请求加载时，当前协程挂起，成功回调后，将其恢复。

## 问题 ##

- 启动和退出
    
    启动要自己扩展守护进程功能么？还是写个程序popen？
    云风说：使用nohup

    如何正确的关闭，以便通知各个模块进行存盘？
    云风blog：[如何安全的退出 skynet](http://blog.codingnow.com/2013/08/exit_skynet.html) 

- 几种address的区别
    
    address 可以理解为handle的变量名，有几种格式：
    - `:name`, name是handle的16进制，一般用于会重复存在的service，如:agent
    - `.name`, name是本进程唯一的，集群内可以有多个。
    - `name`， name是集群内唯一的，（后注册的会覆盖前面注册的）。

- `skynet.newservice`和`skynet.launch`区别
    
    `skynet.newservice` 等同于 `skynet.launch(snlua, lua模块`，并在其退出或出错时，通知创建者。
    
- skynet.ret 封装的不好。

    如果不慎调用两次，会出现很难懂的错误日志，不利于查错。
    只接受字符串参数，不支持自动打包。
    云风说：这两个都是为了兼容老项目而无法改进其封装的形式。

[acai]: http://github.com/dpull
[dinghim]: https://github.com/dinghim